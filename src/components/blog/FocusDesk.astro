---
import Title from "@components/global/Title.astro";
import { getLangFromUrl, useTranslations } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section>
	<div class="top-[-10rem]transform-gpu absolute inset-x-0 overflow-hidden blur-3xl sm:top-[-20rem]" aria-hidden="true">
		<div class="gradient-element"></div>
	</div>
	<div class="mx-auto flex flex-col gap-16 px-8 py-12 md:px-12 lg:pt-16 2xl:max-w-7xl">
		<!-- svg: first layer -->
		<svg class="hidden" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
			<filter id="article-noise-filter">
				<feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"></feTurbulence>
			</filter>
		</svg>
		
		<Title title="Focus Mode" subtitle="Your Digital Study Desk" class="pb-6 pt-8 uppercase" />
		
		<!-- Main Content Area -->
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 min-h-[600px]">
			<!-- Focus Monitor & Notes - Left Side (2/3 width) -->
			<div class="lg:col-span-2 space-y-6">
				<!-- Large Camera Feed Section -->
				<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
					<h3 class="text-2xl font-semibold mb-6 text-black text-center">Focus Monitor</h3>
					
					<!-- Camera Display - Much Larger -->
					<div class="relative bg-black/50 rounded-lg overflow-hidden mb-6 aspect-video h-96">
						<video id="cameraFeed" autoplay muted class="w-full h-full object-cover"></video>
						<div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center text-white/60">
							<div class="text-center">
								<svg class="w-24 h-24 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
									<path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586l-.707-.707A1 1 0 0013 4H7a1 1 0 00-.707.293L5.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
								</svg>
								<p class="text-lg">Camera Disabled</p>
							</div>
						</div>
					</div>

					<!-- Camera Controls -->
                     
					<div class="grid grid-cols-2 gap-4 mb-4">
						<button id="toggleCamera" class="squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-3 px-6 text-lg font-medium">
							Enable Camera
						</button>
						<button id="recordBtn" class="squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-3 px-6 text-lg font-medium" disabled>
							Record
						</button>
					</div>
					
					<!-- Timelapse Controls -->
					<div class="space-y-4 mb-4">
						<div>
							<label class="block text-sm font-medium text-black/80 mb-2">Capture Interval</label>
							<div class="flex items-center gap-3">
								<input type="range" id="intervalSlider" min="100" max="5000" value="1000" 
									class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
								<span id="intervalValue" class="text-sm font-medium text-black min-w-[60px]">1.0s</span>
							</div>
						</div>
						<div>
							<label class="block text-sm font-medium text-black/80 mb-2">Playback Speed</label>
							<div class="flex items-center gap-3">
								<input type="range" id="speedSlider" min="5" max="60" value="30" 
									class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
								<span id="speedValue" class="text-sm font-medium text-black min-w-[60px]">30 FPS</span>
							</div>
						</div>
					</div>
					
					<div class="grid grid-cols-2 gap-4 mb-4">
						<button id="startTimelapse" class="squircle-bg rounded-lg bg-green-600 text-white transition-all hover:bg-green-700 py-3 px-6 text-lg font-medium" disabled>
							‚ñ∂ Start Timelapse
						</button>
						<button id="stopTimelapse" class="squircle-bg rounded-lg bg-red-600 text-white transition-all hover:bg-red-700 py-3 px-6 text-lg font-medium" disabled>
							‚èπ Stop Timelapse
						</button>
					</div>
					
					<button id="downloadTimelapse" class="w-full squircle-bg rounded-lg bg-blue-600 text-white transition-all hover:bg-blue-700 py-3 px-6 text-lg font-medium mb-4" disabled>
						Download Latest
					</button>
					
					<p class="text-sm text-black/50 text-center">Monitor your focus and posture during study sessions</p>
				</div>

						<!-- Recordings Section -->
		<div class="mt-8">
			<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
				<h3 class="text-xl font-semibold mb-4 text-black text-center">üìπ Recent Time-lapses</h3>
				<div id="recordingsList" class="space-y-4">
					<p class="text-center text-black/60 py-8">
						No recordings yet. Start your first time-lapse above! üé•
					</p>
				</div>
			</div>
		</div>
	</div>
</section>

				<!-- Session Notes -->
				<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
					<h3 class="text-xl font-semibold mb-4 text-black">Session Notes</h3>
					<textarea 
						placeholder="Take notes during your focus session..."
						class="w-full h-64 bg-white border border-gray-300 rounded-md px-3 py-2 text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
					></textarea>
					<div class="mt-4 flex justify-between items-center">
						<span class="text-sm text-black/60" id="charCount">0 characters</span>
						<button class="squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white px-4 py-2">
							Save Notes
						</button>
					</div>
				</div>

				<!-- Study Session Info -->
				<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
					<h3 class="text-xl font-semibold mb-4 text-black">Current Session</h3>
					<div class="grid grid-cols-2 gap-4">
						<div>
							<label class="block text-sm font-medium text-black/80 mb-2">Session Type</label>
							<select class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-blue-500">
								<option value="study">Study Session</option>
								<option value="work">Work Session</option>
								<option value="creative">Creative Work</option>
								<option value="reading">Reading</option>
							</select>
						</div>
						<div>
							<label class="block text-sm font-medium text-black/80 mb-2">Session Goal</label>
							<input type="text" placeholder="e.g., Complete Chapter 3" class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
						</div>
					</div>
				</div>
			</div>

			<!-- Right Sidebar - Timer & Controls (1/3 width) -->
			<div class="space-y-6">
				<!-- Timer Section -->
				<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
					<h3 class="text-xl font-semibold mb-4 text-black text-center">Focus Timer</h3>
					
					<!-- Timer Display -->
					<div class="text-center mb-6">
						<div class="text-4xl font-mono font-bold text-black mb-2" id="timerDisplay">25:00</div>
						<div class="text-sm text-black/60" id="timerStatus">Ready to start</div>
					</div>

					<!-- Timer Presets -->
					<div class="grid grid-cols-3 gap-2 mb-4">
						<button class="preset-btn squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-2 text-sm" data-minutes="25">
							25m
						</button>
						<button class="preset-btn squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-2 text-sm" data-minutes="45">
							45m
						</button>
						<button class="preset-btn squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-2 text-sm" data-minutes="60">
							60m
						</button>
					</div>

					<!-- Timer Controls -->
					<div class="space-y-2">
						<button id="startBtn" class="w-full squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-4">
							Start
						</button>
						<button id="pauseBtn" class="w-full squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-4" disabled>
							Pause
						</button>
						<button id="resetBtn" class="w-full squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-4">
							Reset
						</button>
					</div>
				</div>

				<!-- Session Stats -->
				<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
					<h3 class="text-xl font-semibold mb-4 text-black">Today's Progress</h3>
					<div class="space-y-4">
						<div class="text-center">
							<div class="text-2xl font-bold text-blue-600" id="sessionsCompleted">0</div>
							<div class="text-sm text-black/60">Sessions Completed</div>
						</div>
						<div class="text-center">
							<div class="text-2xl font-bold text-green-600" id="totalFocusTime">0m</div>
							<div class="text-sm text-black/60">Focus Time</div>
						</div>
						<div class="text-center">
							<div class="text-2xl font-bold text-purple-600" id="currentStreak">0</div>
							<div class="text-sm text-black/60">Day Streak</div>
						</div>
					</div>
				</div>

				<!-- Quick Actions -->
				<div class="bg-white/90 backdrop-blur-md rounded-lg p-6 border border-gray/20">
					<h3 class="text-xl font-semibold mb-4 text-black text-center">Quick Actions</h3>
					<div class="space-y-2">
						<button class="w-full squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-4">
							Break Time
						</button>
						<button class="w-full squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-4">
							Background Sounds
						</button>
						<button class="w-full squircle-bg rounded-lg bg-zinc-900 text-slate-200 transition-all hover:text-white py-2 px-4">
							Do Not Disturb
						</button>
					</div>
				</div>
			</div>
		</div>
		


<style>
	.gradient-element {
		@apply relative left-1/2 -z-10 aspect-[1155/678] w-[36.125rem] max-w-none -translate-x-1/2 rotate-[30deg] bg-gradient-to-tr from-[#a2d4a0] to-[#aac887] opacity-30 sm:left-[calc(50%-40rem)] sm:w-[72.1875rem];
		clip-path: polygon(
			74.1% 44.1%,
			100% 61.6%,
			97.5% 26.9%,
			85.5% 0.1%,
			80.7% 2%,
			72.5% 32.5%,
			60.2% 62.4%,
			52.4% 68.1%,
			47.5% 58.3%,
			45.2% 34.5%,
			27.5% 76.7%,
			0.1% 64.9%,
			17.9% 100%,
			27.6% 76.8%,
			76.1% 97.7%,
			74.1% 44.1%
		);
	}
</style>

<script src="https://cdn.jsdelivr.net/npm/whammy@0.0.1/whammy.min.js"></script>
<script>
	class FocusDesk {
		private timer: number | null = null;
		private timeRemaining: number = 25 * 60; // 25 minutes in seconds
		private isRunning: boolean = false;
		private cameraStream: MediaStream | null = null;
		private isRecording: boolean = false;
		private timelapseFrames: string[] = [];
		private timelapseInterval: number | null = null;
		private isTimelapseRecording: boolean = false;
		private canvas: HTMLCanvasElement;
		private ctx: CanvasRenderingContext2D | null;
		private recordings: any[] = [];
		private captureIntervalMs: number = 1000; // Default 1 second
		private playbackFps: number = 30; // Default 30 fps

		constructor() {
			// Initialize canvas for frame capture
			this.canvas = document.createElement('canvas');
			this.ctx = this.canvas.getContext('2d');
			
			this.initializeElements();
			this.setupEventListeners();
			this.loadStats();
			this.checkWhammyAvailability();
		}

		private checkWhammyAvailability() {
			// Check if Whammy.js is loaded
			setTimeout(() => {
				if (typeof (window as any).Whammy === 'undefined') {
					console.warn('Whammy.js not loaded - timelapse will use fallback method');
				} else {
					console.log('Whammy.js loaded successfully');
				}
			}, 1000);
		}

		private initializeElements() {
			this.updateTimerDisplay();
			this.updateDownloadButton();
		}

		private setupEventListeners() {
			// Timer controls
			document.getElementById('startBtn')?.addEventListener('click', () => this.startTimer());
			document.getElementById('pauseBtn')?.addEventListener('click', () => this.pauseTimer());
			document.getElementById('resetBtn')?.addEventListener('click', () => this.resetTimer());

			// Timer presets
			document.querySelectorAll('.preset-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const minutes = parseInt((e.target as HTMLElement).dataset.minutes || '25');
					this.setTimer(minutes);
				});
			});

			// Camera controls
			document.getElementById('toggleCamera')?.addEventListener('click', () => this.toggleCamera());
			document.getElementById('recordBtn')?.addEventListener('click', () => this.toggleRecording());

			// Timelapse controls
			document.getElementById('startTimelapse')?.addEventListener('click', () => this.startTimelapse());
			document.getElementById('stopTimelapse')?.addEventListener('click', () => this.stopTimelapse());
			document.getElementById('downloadTimelapse')?.addEventListener('click', () => this.downloadLatest());

			// Slider controls
			document.getElementById('intervalSlider')?.addEventListener('input', (e) => {
				const value = parseInt((e.target as HTMLInputElement).value);
				this.captureIntervalMs = value;
				const display = document.getElementById('intervalValue');
				if (display) {
					display.textContent = (value / 1000).toFixed(1) + 's';
				}
			});

			document.getElementById('speedSlider')?.addEventListener('input', (e) => {
				const value = parseInt((e.target as HTMLInputElement).value);
				this.playbackFps = value;
				const display = document.getElementById('speedValue');
				if (display) {
					display.textContent = value + ' FPS';
				}
			});

			// Notes character count
			const notesTextarea = document.querySelector('textarea');
			notesTextarea?.addEventListener('input', () => {
				const charCount = document.getElementById('charCount');
				if (charCount) {
					charCount.textContent = `${notesTextarea.value.length} characters`;
				}
			});
		}

		private setTimer(minutes: number) {
			this.timeRemaining = minutes * 60;
			this.updateTimerDisplay();
			if (this.isRunning) {
				this.pauseTimer();
			}
		}

		private startTimer() {
			if (!this.isRunning) {
				this.isRunning = true;
				this.timer = window.setInterval(() => {
					this.timeRemaining--;
					this.updateTimerDisplay();
					
					if (this.timeRemaining <= 0) {
						this.completeSession();
					}
				}, 1000);

				this.updateControls();
				this.updateTimerStatus('Focus time! Stay concentrated.');
			}
		}

		private pauseTimer() {
			if (this.isRunning && this.timer) {
				this.isRunning = false;
				clearInterval(this.timer);
				this.timer = null;
				this.updateControls();
				this.updateTimerStatus('Timer paused');
			}
		}

		private resetTimer() {
			if (this.timer) {
				clearInterval(this.timer);
				this.timer = null;
			}
			this.isRunning = false;
			this.timeRemaining = 25 * 60;
			this.updateTimerDisplay();
			this.updateControls();
			this.updateTimerStatus('Ready to start');
		}

		private completeSession() {
			if (this.timer) {
				clearInterval(this.timer);
				this.timer = null;
			}
			this.isRunning = false;
			this.updateControls();
			this.updateTimerStatus('Session completed! Great work!');
			this.incrementStats();
			
			// Show completion notification
			if (Notification.permission === 'granted') {
				new Notification('Focus Session Complete!', {
					body: 'Great job! You completed your focus session.',
					icon: '/favicon.ico'
				});
			}
		}

		private updateTimerDisplay() {
			const minutes = Math.floor(this.timeRemaining / 60);
			const seconds = this.timeRemaining % 60;
			const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
			
			const timerDisplay = document.getElementById('timerDisplay');
			if (timerDisplay) {
				timerDisplay.textContent = display;
			}
		}

		private updateTimerStatus(status: string) {
			const statusElement = document.getElementById('timerStatus');
			if (statusElement) {
				statusElement.textContent = status;
			}
		}

		private updateControls() {
			const startBtn = document.getElementById('startBtn') as HTMLButtonElement;
			const pauseBtn = document.getElementById('pauseBtn') as HTMLButtonElement;
			
			if (startBtn && pauseBtn) {
				startBtn.disabled = this.isRunning;
				pauseBtn.disabled = !this.isRunning;
			}
		}

		private async toggleCamera() {
			const video = document.getElementById('cameraFeed') as HTMLVideoElement;
			const placeholder = document.getElementById('cameraPlaceholder');
			const toggleBtn = document.getElementById('toggleCamera');

			if (!this.cameraStream) {
				try {
					this.cameraStream = await navigator.mediaDevices.getUserMedia({ 
						video: { width: 640, height: 480 },
						audio: false 
					});
					
					if (video) {
						video.srcObject = this.cameraStream;
						video.style.display = 'block';
					}
					if (placeholder) {
						placeholder.style.display = 'none';
					}
					if (toggleBtn) {
						toggleBtn.textContent = 'Disable Camera';
					}
					
					const recordBtn = document.getElementById('recordBtn') as HTMLButtonElement;
					const startTimelapseBtn = document.getElementById('startTimelapse') as HTMLButtonElement;
					const stopTimelapseBtn = document.getElementById('stopTimelapse') as HTMLButtonElement;
					const downloadTimelapseBtn = document.getElementById('downloadTimelapse') as HTMLButtonElement;
					
					if (recordBtn) {
						recordBtn.disabled = false;
					}
					if (startTimelapseBtn) {
						startTimelapseBtn.disabled = false;
					}
				} catch (error) {
					console.error('Error accessing camera:', error);
					alert('Could not access camera. Please check permissions.');
				}
			} else {
				this.cameraStream.getTracks().forEach(track => track.stop());
				this.cameraStream = null;
				
				if (video) {
					video.style.display = 'none';
				}
				if (placeholder) {
					placeholder.style.display = 'flex';
				}
				if (toggleBtn) {
					toggleBtn.textContent = 'Enable Camera';
				}
				
				const recordBtn = document.getElementById('recordBtn') as HTMLButtonElement;
				const startTimelapseBtn = document.getElementById('startTimelapse') as HTMLButtonElement;
				const stopTimelapseBtn = document.getElementById('stopTimelapse') as HTMLButtonElement;
				const downloadTimelapseBtn = document.getElementById('downloadTimelapse') as HTMLButtonElement;
				
				if (recordBtn) {
					recordBtn.disabled = true;
					recordBtn.textContent = 'Record';
				}
				if (startTimelapseBtn) {
					startTimelapseBtn.disabled = true;
				}
				if (stopTimelapseBtn) {
					stopTimelapseBtn.disabled = true;
				}
				
				// Stop any ongoing timelapse
				if (this.isTimelapseRecording) {
					this.stopTimelapse();
				}
				
				this.isRecording = false;
			}
		}

		private toggleRecording() {
			const recordBtn = document.getElementById('recordBtn');
			
			if (!this.isRecording) {
				this.isRecording = true;
				if (recordBtn) {
					recordBtn.textContent = 'Stop Recording';
					recordBtn.className = recordBtn.className.replace('bg-red-600', 'bg-gray-600');
				}
				// Here you would implement actual recording functionality
				console.log('Recording started');
			} else {
				this.isRecording = false;
				if (recordBtn) {
					recordBtn.textContent = 'Record';
					recordBtn.className = recordBtn.className.replace('bg-gray-600', 'bg-red-600');
				}
				console.log('Recording stopped');
			}
		}

		private async startTimelapse() {
			if (!this.cameraStream) {
				alert('Please enable camera first');
				return;
			}

			const video = document.getElementById('cameraFeed') as HTMLVideoElement;
			if (!video || video.videoWidth === 0 || video.videoHeight === 0) {
				alert('Camera not ready. Please wait for camera to initialize.');
				return;
			}

			this.timelapseFrames = [];
			this.isTimelapseRecording = true;

			// Update button states
			const startBtn = document.getElementById('startTimelapse') as HTMLButtonElement;
			const stopBtn = document.getElementById('stopTimelapse') as HTMLButtonElement;
			
			if (startBtn) {
				startBtn.disabled = true;
				startBtn.textContent = 'üî¥ Recording...';
			}
			if (stopBtn) {
				stopBtn.disabled = false;
			}

			// Set canvas dimensions
			this.canvas.width = video.videoWidth;
			this.canvas.height = video.videoHeight;

			console.log(`Starting timelapse recording at ${this.canvas.width}x${this.canvas.height}, interval: ${this.captureIntervalMs}ms`);

			// Capture frames at specified interval
			this.timelapseInterval = setInterval(() => {
				if (!this.isTimelapseRecording || !this.ctx) return;
				
				try {
					// Ensure canvas dimensions match video
					if (this.canvas.width !== video.videoWidth || this.canvas.height !== video.videoHeight) {
						this.canvas.width = video.videoWidth;
						this.canvas.height = video.videoHeight;
					}
					
					this.ctx.drawImage(video, 0, 0, this.canvas.width, this.canvas.height);
					
					// Convert to base64 image data
					const frameData = this.canvas.toDataURL("image/jpeg", 0.8);
					this.timelapseFrames.push(frameData);
					
					// Update button text with frame count
					if (startBtn) {
						startBtn.textContent = `üî¥ Recording... (${this.timelapseFrames.length} frames)`;
					}
					
					console.log(`Captured frame ${this.timelapseFrames.length}`);
				} catch (error) {
					console.error('Error capturing frame:', error);
				}
			}, this.captureIntervalMs) as any;

			console.log('Timelapse recording started');
		}

		private async stopTimelapse() {
			if (!this.isTimelapseRecording) return;

			this.isTimelapseRecording = false;
			
			if (this.timelapseInterval) {
				clearInterval(this.timelapseInterval);
				this.timelapseInterval = null;
			}

			// Update button states
			const startBtn = document.getElementById('startTimelapse') as HTMLButtonElement;
			const stopBtn = document.getElementById('stopTimelapse') as HTMLButtonElement;
			
			if (startBtn) {
				startBtn.disabled = false;
				startBtn.textContent = 'Start Timelapse';
			}
			if (stopBtn) {
				stopBtn.disabled = true;
			}

			console.log(`Stopping timelapse with ${this.timelapseFrames.length} frames`);

			if (this.timelapseFrames.length === 0) {
				alert('No frames captured. Try recording for a longer duration.');
				return;
			}

			// Create timelapse video
			await this.createAdvancedTimelapse();
			this.timelapseFrames = [];
		}

		private async createAdvancedTimelapse() {
			try {
				if (!this.ctx) {
					throw new Error('Canvas context not available');
				}

				console.log('Creating advanced timelapse video...');

				// Create a video stream from canvas
				const stream = this.canvas.captureStream(this.playbackFps);
				const mediaRecorder = new MediaRecorder(stream, {
					mimeType: 'video/webm'
				});

				const chunks: BlobPart[] = [];
				
				return new Promise<void>((resolve, reject) => {
					mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
					mediaRecorder.onstop = () => {
						try {
							const blob = new Blob(chunks, { type: 'video/webm' });
							const url = URL.createObjectURL(blob);
							
							const recording = {
								id: Date.now(),
								url: url,
								blob: blob,
								timestamp: new Date(),
								frameCount: this.timelapseFrames.length,
								fps: this.playbackFps,
								duration: (this.timelapseFrames.length / this.playbackFps).toFixed(1),
								interval: this.captureIntervalMs
							};

							this.recordings.unshift(recording);
							this.updateRecordingsList();
							this.updateDownloadButton();
							
							console.log(`Timelapse created: ${this.timelapseFrames.length} frames at ${this.playbackFps}fps`);
							alert(`‚ú® Timelapse created! ${this.timelapseFrames.length} frames at ${this.playbackFps}fps (${recording.duration}s)`);
							resolve();
						} catch (error) {
							reject(error);
						}
					};

					mediaRecorder.onerror = (e) => reject(e);
					mediaRecorder.start();

					// Play through all frames to create the video
					let frameIndex = 0;
					const frameDuration = 1000 / this.playbackFps;

					const playFrames = () => {
						if (frameIndex < this.timelapseFrames.length && this.ctx) {
							const img = new Image();
							img.onload = () => {
								if (this.ctx) {
									this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
									this.ctx.drawImage(img, 0, 0);
									frameIndex++;
									setTimeout(playFrames, frameDuration);
								}
							};
							img.onerror = () => {
								frameIndex++;
								setTimeout(playFrames, frameDuration);
							};
							img.src = this.timelapseFrames[frameIndex];
						} else {
							mediaRecorder.stop();
						}
					};

					setTimeout(playFrames, 100);
				});

			} catch (error) {
				console.error('Error creating advanced timelapse:', error);
				alert(`Error creating timelapse: ${error instanceof Error ? error.message : 'Unknown error'}`);
			}
		}

		private updateRecordingsList() {
			const recordingsList = document.getElementById('recordingsList');
			if (!recordingsList) return;

			if (this.recordings.length === 0) {
				recordingsList.innerHTML = `
					<p class="text-center text-black/60 py-8">
						No recordings yet. Start your first time-lapse above! üé•
					</p>
				`;
				return;
			}

			recordingsList.innerHTML = this.recordings.map(recording => `
				<div class="flex items-center gap-4 p-4 bg-white/50 rounded-lg border border-gray-200">
					<video class="w-20 h-15 rounded object-cover" src="${recording.url}" muted loop autoplay></video>
					<div class="flex-1">
						<div class="font-semibold text-black">Time-lapse ${recording.id}</div>
						<div class="text-sm text-black/60">
							${recording.frameCount} frames ‚Ä¢ ${recording.fps}fps ‚Ä¢ ${recording.duration}s<br>
							Interval: ${(recording.interval/1000).toFixed(1)}s ‚Ä¢ ${recording.timestamp.toLocaleString()}
						</div>
					</div>
					<div class="flex gap-2">
						<button onclick="focusDesk.downloadRecording(${recording.id})" 
								class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
							üíæ Download
						</button>
						<button onclick="focusDesk.playRecording(${recording.id})" 
								class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
							‚ñ∂Ô∏è Play
						</button>
					</div>
				</div>
			`).join('');
		}

		private updateDownloadButton() {
			const downloadBtn = document.getElementById('downloadTimelapse') as HTMLButtonElement;
			if (downloadBtn) {
				downloadBtn.disabled = this.recordings.length === 0;
			}
		}

		private downloadLatest() {
			if (this.recordings.length > 0) {
				this.downloadRecording(this.recordings[0].id);
			}
		}

		private downloadRecording(id: number) {
			const recording = this.recordings.find(r => r.id === id);
			if (!recording) return;

			const a = document.createElement('a');
			a.href = recording.url;
			a.download = `timelapse-${recording.id}.webm`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
		}

		private playRecording(id: number) {
			const recording = this.recordings.find(r => r.id === id);
			if (!recording) return;

			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed; top: 0; left: 0; width: 100%; height: 100%;
				background: rgba(0,0,0,0.9); display: flex; align-items: center;
				justify-content: center; z-index: 1000; backdrop-filter: blur(5px);
			`;
			
			modal.innerHTML = `
				<div style="max-width: 90%; max-height: 90%; position: relative;">
					<video controls autoplay style="width: 100%; height: auto; border-radius: 10px; max-height: 80vh;">
						<source src="${recording.url}" type="video/webm">
					</video>
					<button onclick="this.parentElement.parentElement.remove()" 
							style="position: absolute; top: -40px; right: 0; background: white; 
								   border: none; border-radius: 50%; width: 30px; height: 30px; 
								   cursor: pointer; font-size: 18px; font-weight: bold;">√ó</button>
					<div style="color: white; text-align: center; margin-top: 10px; font-size: 14px;">
						${recording.frameCount} frames ‚Ä¢ ${recording.fps}fps ‚Ä¢ ${recording.duration}s
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			modal.addEventListener('click', (e) => {
				if (e.target === modal) modal.remove();
			});
		}

		private loadStats() {
			// Load stats from localStorage or set defaults
			const stats = {
				sessionsCompleted: parseInt(localStorage.getItem('focusDesk_sessionsCompleted') || '0'),
				totalFocusTime: parseInt(localStorage.getItem('focusDesk_totalFocusTime') || '0'),
				currentStreak: parseInt(localStorage.getItem('focusDesk_currentStreak') || '0')
			};

			this.updateStatsDisplay(stats);
		}

		private incrementStats() {
			const currentStats = {
				sessionsCompleted: parseInt(localStorage.getItem('focusDesk_sessionsCompleted') || '0') + 1,
				totalFocusTime: parseInt(localStorage.getItem('focusDesk_totalFocusTime') || '0') + 25,
				currentStreak: parseInt(localStorage.getItem('focusDesk_currentStreak') || '0') + 1
			};

			// Save to localStorage
			localStorage.setItem('focusDesk_sessionsCompleted', currentStats.sessionsCompleted.toString());
			localStorage.setItem('focusDesk_totalFocusTime', currentStats.totalFocusTime.toString());
			localStorage.setItem('focusDesk_currentStreak', currentStats.currentStreak.toString());

			this.updateStatsDisplay(currentStats);
		}

		private updateStatsDisplay(stats: any) {
			const sessionsElement = document.getElementById('sessionsCompleted');
			const focusTimeElement = document.getElementById('totalFocusTime');
			const streakElement = document.getElementById('currentStreak');

			if (sessionsElement) sessionsElement.textContent = stats.sessionsCompleted.toString();
			if (focusTimeElement) focusTimeElement.textContent = `${stats.totalFocusTime}m`;
			if (streakElement) streakElement.textContent = stats.currentStreak.toString();
		}
	}

	// Initialize when DOM is loaded
	document.addEventListener('DOMContentLoaded', () => {
		(window as any).focusDesk = new FocusDesk();
		
		// Request notification permission
		if ('Notification' in window && Notification.permission === 'default') {
			Notification.requestPermission();
		}
	});
</script>
